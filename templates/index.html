<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>–ê–≥–µ–Ω—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</title>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Google Sans', sans-serif;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background-color: #000;
      position: relative;
    }

    .global-logout {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 1000;
      background: rgba(255, 0, 0, 0.5);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .global-logout:hover {
      background: rgba(255, 0, 0, 0.7);
    }

    .bg-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -3;
      pointer-events: none;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: -2;
    }

    #app {
      position: relative;
      z-index: 10;
      display: flex;
      justify-content: center;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    .container {
      display: flex;
      gap: 72px;
      height: 100%;
      max-width: 1440px;
      padding: 20px;
      width: 100%;
    }

    .left-panel {
      background: rgba(128, 128, 128, 0.7);
      border-radius: 28px;
      width: 960px;
      height: 100%;
      max-height: 900px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 6px 32px rgba(0, 0, 0, 0.15);
    }

    .header {
      background: rgba(64, 64, 64, 0.9);
      color: white;
      padding: 20px 32px;
      font-weight: 600;
      font-size: 26px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    #view-requests-btn {
      background: rgba(255, 204, 0, 0.9);
      color: #000;
      border: none;
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    #view-requests-btn:hover {
      background: rgba(255, 204, 0, 1);
    }

    .chat-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      padding: 0 32px 32px;
      overflow: hidden;
    }

    .chat-messages {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px 0;
      margin-top: 16px;
    }

    .chat-messages::-webkit-scrollbar {
      width: 12px;
    }
    .chat-messages::-webkit-scrollbar-track {
      background: rgba(64, 64, 64, 0.3);
      border-radius: 10px;
    }
    .chat-messages::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #7bed9f, #55d6be);
      border-radius: 10px;
      border: 3px solid transparent;
      background-clip: content-box;
    }
    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #55d6be, #3ab19f);
    }

    .message {
      padding: 16px 24px;
      font-size: 16px;
      line-height: 1.5;
      word-wrap: break-word;
      max-width: 80%;
      border-radius: 20px;
    }

    .message.bot {
      background: rgba(96, 96, 96, 0.8);
      color: white;
      align-self: flex-start;
      border-radius: 20px 20px 20px 0;
    }

    .message.user {
      background: linear-gradient(135deg, #7bed9f, #55d6be);
      color: white;
      align-self: flex-end;
      border-radius: 20px 20px 0 20px;
    }

    .input-area {
      display: flex;
      flex-direction: column;
      gap: 16px;
      flex-shrink: 0;
      margin-top: auto;
    }

    .file-button {
      background: rgba(64, 64, 64, 0.8);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      align-self: flex-start;
    }

    .search-input-wrapper {
      display: flex;
      align-items: center;
      background: rgba(64, 64, 64, 0.8);
      border-radius: 20px;
      padding: 16px 24px;
      gap: 16px;
    }

    .search-input {
      flex: 1;
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      outline: none;
    }

    .send-button {
      background: linear-gradient(135deg, #7bed9f, #55d6be);
      color: white;
      border-radius: 50%;
      width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .send-button svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    .right-panel {
      background: rgba(128, 128, 128, 0.7);
      border-radius: 28px;
      padding: 32px;
      width: 480px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      box-shadow: 0 6px 32px rgba(0, 0, 0, 0.15);
      max-height: 900px;
      overflow: visible;
    }

    .right-header {
      color: white;
      font-weight: 600;
      font-size: 26px;
      text-align: center;
      margin-bottom: 16px;
    }

    .filter-row {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .label {
      color: white;
      font-size: 16px;
      min-width: 160px;
    }

    .custom-select select,
    .date-input,
    .year-input {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background: rgba(96, 96, 96, 0.8);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 12px 20px;
      font-size: 16px;
      width: 100%;
      cursor: pointer;
      outline: none;
      font-family: 'Google Sans', sans-serif;
    }

    .custom-select {
      position: relative;
      flex: 1;
    }

    .custom-select::after {
      content: "‚ñº";
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: white;
      pointer-events: none;
      font-size: 14px;
    }

    .filter-button {
      background: linear-gradient(135deg, #7bed9f, #55d6be);
      color: white;
      font-weight: 600;
      font-size: 18px;
      width: fit-content;
      padding: 12px 28px;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      margin-left: auto;
      margin-right: auto;
      cursor: pointer;
      text-align: center;
    }

    .view-all-btn {
      background: rgba(64, 64, 64, 0.8);
      color: white;
      font-size: 16px;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      text-align: center;
      margin-top: 10px;
    }

    .calendar-box {
      background: white;
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      box-sizing: border-box;
    }

    .calendar-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .month-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-btn {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: black;
      padding: 4px 8px;
    }

    #current-month {
      font-size: 18px;
      font-weight: bold;
      color: black;
    }

    .year-input {
      width: 80px;
      text-align: center;
      font-size: 16px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      width: 100%;
    }

    .weekday {
      font-size: 12px;
      color: #888;
      text-align: center;
    }

    .day {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #888;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .day.has-event {
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
    }

    .day:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    /* Sidebars */
    #events-sidebar,
    #requests-sidebar {
      position: fixed;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(25, 25, 25, 0.96);
      color: white;
      padding: 32px;
      overflow-y: auto;
      z-index: 1001;
      transition: transform 0.3s ease;
    }

    #events-sidebar {
      right: 0;
      transform: translateX(100%);
    }

    #events-sidebar.active {
      transform: translateX(0);
    }

    #requests-sidebar {
      left: 0;
      transform: translateX(-100%);
    }

    #requests-sidebar.active {
      transform: translateX(0);
    }

    #events-sidebar-header,
    #requests-sidebar-header {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #close-sidebar,
    #close-requests-sidebar {
      background: #444;
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .event-item,
    .request-item {
      background: rgba(60, 60, 60, 0.6);
      padding: 16px;
      margin-bottom: 16px;
      border-radius: 14px;
      font-size: 15px;
      line-height: 1.4;
    }

    .event-meta {
      color: #7bed9f;
      font-size: 14px;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .event-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 6px;
      color: white;
    }

    .request-meta {
      color: #ffcc00;
      font-size: 14px;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .request-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 6px;
      color: white;
    }

    .request-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }

    .request-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-approve { background: #2ed573; color: white; }
    .btn-reject { background: #ff4757; color: white; }

    .no-events,
    .no-requests {
      color: #888;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    /* === –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø (—Ç–æ–ª—å–∫–æ ‚â§ 768px) === */
    @media (max-width: 768px) {
      html, body {
        height: auto;
        overflow: visible;
      }

      /* –í–ê–ñ–ù–û: –ù–ï –£–ë–ò–†–ê–ï–ú –≤–∏–¥–µ–æ! –û—Å—Ç–∞–≤–ª—è–µ–º, –Ω–æ —Å fallback */
      body {
        /* –≠—Ç–æ—Ç —Ñ–æ–Ω –±—É–¥–µ—Ç, –µ—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è */
        background: linear-gradient(135deg, #0c0c0c, #1a1a1a);
      }

      /* –í–∏–¥–µ–æ –æ—Å—Ç–∞—ë—Ç—Å—è, –Ω–æ –¥–µ–ª–∞–µ–º –µ–≥–æ –Ω–µ–º–Ω–æ–≥–æ –º–µ–Ω–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
      .bg-video {
        opacity: 0.9;
        z-index: -3;
      }

      .overlay {
        background: rgba(0, 0, 0, 0.5); /* —á—É—Ç—å —Ç–µ–º–Ω–µ–µ */
        z-index: -2;
      }

      .global-logout {
        position: fixed;
        z-index: 1000;
      }

      #app {
        padding-top: 70px;
        height: auto;
        overflow: visible;
      }

      .container {
        flex-direction: column;
        padding: 12px 12px 120px;
        gap: 24px;
        height: auto;
        max-width: 100%;
        overflow: visible;
      }

      .left-panel {
        width: 100% !important;
        height: 75vh !important;
        max-height: none !important;
        min-height: 0;
        border-radius: 20px !important;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        background: rgba(30, 30, 30, 0.85) !important;
      }

      .chat-content {
        padding: 0 16px 16px;
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-messages {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        padding: 12px 0;
        margin-top: 12px;
        gap: 12px;
      }

      .message {
        padding: 12px 16px;
        font-size: 15px;
        max-width: 85%;
      }

      .input-area {
        padding-bottom: 10px;
      }

      .search-input-wrapper {
        padding: 12px 16px;
      }

      .search-input {
        min-height: 44px;
        font-size: 16px;
      }

      .send-button {
        width: 50px;
        height: 50px;
      }

      .send-button svg {
        width: 22px;
        height: 22px;
      }

      .right-panel {
        width: 100% !important;
        height: auto !important;
        max-height: none !important;
        padding: 20px;
        border-radius: 20px !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        background: rgba(30, 30, 30, 0.85) !important;
      }

      .right-header {
        font-size: 20px;
        margin-bottom: 16px;
      }

      .filter-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .label {
        font-size: 15px;
        min-width: auto;
      }

      .custom-select select,
      .date-input,
      .year-input {
        padding: 12px 16px;
        font-size: 15px;
        border-radius: 16px;
      }

      .filter-button,
      .view-all-btn {
        width: 100%;
        padding: 14px;
        font-size: 16px;
        margin: 0;
      }

      .calendar-box {
        display: block;
        margin-top: 16px;
      }

      .toggle-calendar {
        display: none !important;
      }

      #events-sidebar,
      #requests-sidebar {
        width: 100%;
        padding: 20px;
        background: rgba(20, 20, 20, 0.95) !important;
      }
    }
  </style>
</head>
<body>

  <form method="POST" action="/logout">
    <button type="submit" class="global-logout">–í—ã–π—Ç–∏</button>
  </form>

  <!-- –í–∏–¥–µ–æ –æ—Å—Ç–∞—ë—Ç—Å—è –í–ï–ó–î–ï -->
  <video class="bg-video" autoplay muted loop playsinline>
    <source src="{{ url_for('static', filename='video.mp4') }}" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <div id="app">
    <div class="container">
      <div class="left-panel">
        <div class="header">
          <span>–ê–≥–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</span>
          {% if user_type == '—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å' or user_type == 'admin' %}
            <button id="view-requests-btn">üîî –ó–∞—è–≤–∫–∏</button>
          {% endif %}
        </div>
        <div class="chat-content">
          <div class="chat-messages" id="chat-messages">
            <div class="message bot">
              –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ IT-–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è. –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã.
            </div>
          </div>
          <div class="input-area">
            <div class="file-button">üìé –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</div>
            <div class="search-input-wrapper">
              <input type="text" class="search-input" id="user-input" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ö–∞–∫–∞—Ç–æ–Ω –ø–æ –ò–ò –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ">
              <div class="send-button" id="send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="right-panel">
        <div class="right-header">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</div>
        <div class="filter-row">
          <div class="label">–ì–æ—Ä–æ–¥:</div>
          <div class="custom-select">
            <select id="city-filter">
              <option value="">–≤—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥</option>
              <option value="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
              <option value="–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥">–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥</option>
              <option value="–ú—É—Ä–º–∞–Ω—Å–∫">–ú—É—Ä–º–∞–Ω—Å–∫</option>
            </select>
          </div>
        </div>
        <div class="filter-row">
          <div class="label">–î–∞—Ç–∞:</div>
          <input type="text" class="date-input" id="date-filter" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 25.11.25">
        </div>
        <div class="filter-row">
          <div class="label">–ì–æ—Å—Ç–∏:</div>
          <div class="custom-select">
            <select id="guests-filter">
              <option value="">–ª—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>
              <option value="1-5">1‚Äì5</option>
              <option value="5-10">5‚Äì10</option>
              <option value="10-20">10‚Äì20</option>
              <option value="20-50">20‚Äì50</option>
              <option value="50-100">50‚Äì100</option>
              <option value="100-200">100‚Äì200</option>
              <option value="200-500">200‚Äì500</option>
              <option value="500-1000">500‚Äì1000</option>
              <option value="1000+">1000+</option>
            </select>
          </div>
        </div>
        <div class="filter-row">
          <div class="label">–°–ø–∏–∫–µ—Ä—ã:</div>
          <div class="custom-select">
            <select id="speakers-filter">
              <option value="">–ª—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>
              <option value="1-3">1‚Äì3</option>
              <option value="3-5">3‚Äì5</option>
              <option value="5-10">5‚Äì10</option>
              <option value="10-20">10‚Äì20</option>
              <option value="20-50">20‚Äì50</option>
              <option value="50+">50+</option>
            </select>
          </div>
        </div>
        <div class="filter-row">
          <div class="label">–¢–∏–ø:</div>
          <div class="custom-select">
            <select id="type-filter">
              <option value="">–ª—é–±–æ–π —Ç–∏–ø</option>
              <option value="—Ö–∞–∫–∞—Ç–æ–Ω">–•–∞–∫–∞—Ç–æ–Ω</option>
              <option value="–º–∏—Ç–∞–ø">–ú–∏—Ç–∞–ø</option>
              <option value="–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è">–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</option>
              <option value="–≤–æ—Ä–∫—à–æ–ø">–í–æ—Ä–∫—à–æ–ø</option>
              <option value="–ª–µ–∫—Ü–∏—è">–õ–µ–∫—Ü–∏—è</option>
              <option value="—Ñ–æ—Ä—É–º">–§–æ—Ä—É–º</option>
            </select>
          </div>
        </div>
        <div class="filter-button" id="apply-filters">–ü–æ–∏—Å–∫</div>
        <div class="view-all-btn" id="view-all-btn">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>

        <div class="calendar-box">
          <div class="calendar-controls">
            <div class="month-nav">
              <button class="nav-btn" id="prev-month">‚Üê</button>
              <div id="current-month">–ù–æ—è–±—Ä—å</div>
              <button class="nav-btn" id="next-month">‚Üí</button>
            </div>
            <input type="text" class="year-input" id="year-input" placeholder="–ì–ì–ì–ì" maxlength="4">
          </div>
          <div class="calendar-grid" id="calendar-grid">
            <div class="weekday">–ü–Ω</div>
            <div class="weekday">–í—Ç</div>
            <div class="weekday">–°—Ä</div>
            <div class="weekday">–ß—Ç</div>
            <div class="weekday">–ü—Ç</div>
            <div class="weekday">–°–±</div>
            <div class="weekday">–í—Å</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="events-sidebar">
    <div id="events-sidebar-header">
      –í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
      <button id="close-sidebar">√ó</button>
    </div>
    <div id="all-events-list"></div>
  </div>

  <div id="requests-sidebar">
    <div id="requests-sidebar-header">
      –ó–∞—è–≤–∫–∏ –æ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
      <button id="close-requests-sidebar">√ó</button>
    </div>
    <div id="manager-requests-list"></div>
  </div>

  <script>
    const USER_TYPE = "{{ user_type }}";
    const USER_LOGIN = "{{ session.get('user_login', '') }}";

    document.addEventListener('DOMContentLoaded', function() {
      // –ù–ï —É–¥–∞–ª—è–µ–º –≤–∏–¥–µ–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö! –û—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ.
      // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã (Safari, Chrome) –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç muted autoplay –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö.

      const chatMessages = document.getElementById('chat-messages');
      const userInput = document.getElementById('user-input');
      const sendBtn = document.getElementById('send-btn');
      const applyFiltersBtn = document.getElementById('apply-filters');
      const viewAllBtn = document.getElementById('view-all-btn');
      const closeSidebarBtn = document.getElementById('close-sidebar');
      const eventsSidebar = document.getElementById('events-sidebar');
      const allEventsList = document.getElementById('all-events-list');
      const yearInput = document.getElementById('year-input');

      const viewRequestsBtn = document.getElementById('view-requests-btn');
      const requestsSidebar = document.getElementById('requests-sidebar');
      const closeRequestsSidebarBtn = document.getElementById('close-requests-sidebar');
      const managerRequestsList = document.getElementById('manager-requests-list');

      let currentYear = new Date().getFullYear();
      let currentMonth = new Date().getMonth();
      let eventsMap = {};

      yearInput.value = currentYear;

      fetch('/get_future_events')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateCalendarFromEvents(data.events);
          }
        });

      function updateCalendarFromEvents(events) {
        eventsMap = {};
        events.forEach(ev => {
          if (ev.date && /^\d{4}-\d{2}-\d{2}$/.test(ev.date)) {
            if (!eventsMap[ev.date]) eventsMap[ev.date] = [];
            eventsMap[ev.date].push(ev);
          }
        });
        renderCalendar();
      }

      function renderCalendar() {
        const shortMonthNames = ["–Ø–Ω–≤", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–ò—é–Ω",
          "–ò—é–ª", "–ê–≤–≥", "–°–µ–Ω", "–û–∫—Ç", "–ù–æ—è", "–î–µ–∫"];

        document.getElementById('current-month').textContent = shortMonthNames[currentMonth];
        yearInput.value = currentYear;

        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const grid = document.getElementById('calendar-grid');
        
        while (grid.children.length > 7) grid.removeChild(grid.lastChild);

        const startDay = (firstDay === 0) ? 6 : firstDay - 1;

        for (let i = 0; i < startDay; i++) {
          const empty = document.createElement('div');
          empty.className = 'day empty';
          grid.appendChild(empty);
        }

        for (let day = 1; day <= daysInMonth; day++) {
          const isoDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const hasEvent = eventsMap[isoDate] && eventsMap[isoDate].length > 0;

          const dayEl = document.createElement('div');
          dayEl.className = `day ${hasEvent ? 'has-event' : ''}`;
          dayEl.textContent = day;
          dayEl.dataset.date = isoDate;

          dayEl.addEventListener('click', () => {
            const events = eventsMap[isoDate] || [];
            if (events.length === 0) {
              alert('–ù–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–∞ —ç—Ç—É –¥–∞—Ç—É.');
              return;
            }
            const event = events[0];
            const message = `–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ?\n\n${event.text}`;
            if (confirm(message)) {
              fetch('/request_registration', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  event_date: isoDate,
                  event_text: event.text
                })
              })
              .then(r => r.json())
              .then(data => {
                alert(data.message || '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.');
              })
              .catch(() => alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å.'));
            }
          });

          grid.appendChild(dayEl);
        }
      }

      document.getElementById('prev-month').addEventListener('click', () => {
        if (currentMonth === 0) { currentMonth = 11; currentYear--; }
        else currentMonth--;
        renderCalendar();
      });

      document.getElementById('next-month').addEventListener('click', () => {
        if (currentMonth === 11) { currentMonth = 0; currentYear++; }
        else currentMonth++;
        renderCalendar();
      });

      yearInput.addEventListener('change', () => {
        const year = parseInt(yearInput.value);
        if (!isNaN(year) && year >= 1900 && year <= 2100) {
          currentYear = year;
          renderCalendar();
        } else {
          yearInput.value = currentYear;
        }
      });

      function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function sendTextMessage(text) {
        const userMsg = document.createElement('div');
        userMsg.className = 'message user';
        userMsg.textContent = text;
        chatMessages.appendChild(userMsg);
        scrollToBottom();

        fetch('/send_message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text }),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const botMsg = document.createElement('div');
            botMsg.className = 'message bot';
            botMsg.textContent = data.response;
            chatMessages.appendChild(botMsg);
            scrollToBottom();
            if (data.events) updateCalendarFromEvents(data.events);
          }
        })
        .catch(() => {
          const botMsg = document.createElement('div');
          botMsg.className = 'message bot';
          botMsg.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.';
          chatMessages.appendChild(botMsg);
          scrollToBottom();
        });
      }

      sendBtn.addEventListener('click', () => {
        const text = userInput.value.trim();
        if (text) {
          userInput.value = '';
          sendTextMessage(text);
        }
      });

      userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          const text = userInput.value.trim();
          if (text) {
            userInput.value = '';
            sendTextMessage(text);
          }
        }
      });

      applyFiltersBtn.addEventListener('click', () => {
        const filters = {
          city: document.getElementById('city-filter').value,
          date: document.getElementById('date-filter').value.trim(),
          guests: document.getElementById('guests-filter').value,
          speakers: document.getElementById('speakers-filter').value,
          type: document.getElementById('type-filter').value
        };

        let displayParts = [];
        if (filters.type) displayParts.push(filters.type);
        if (filters.city) displayParts.push(filters.city);
        if (filters.date) displayParts.push(`–¥–∞—Ç–∞ ${filters.date}`);
        if (filters.guests) displayParts.push(`–≥–æ—Å—Ç–µ–π ${filters.guests}`);
        if (filters.speakers) displayParts.push(`—Å–ø–∏–∫–µ—Ä–æ–≤ ${filters.speakers}`);

        if (displayParts.length === 0) {
          alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∏–ª—å—Ç—Ä.");
          return;
        }

        const displayText = "–ü–æ–∏—Å–∫ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º: " + displayParts.join(", ");
        const userMsg = document.createElement('div');
        userMsg.className = 'message user';
        userMsg.textContent = displayText;
        chatMessages.appendChild(userMsg);
        scrollToBottom();

        fetch('/send_filters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filters: filters }),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const botMsg = document.createElement('div');
            botMsg.className = 'message bot';
            botMsg.textContent = data.response;
            chatMessages.appendChild(botMsg);
            scrollToBottom();
            if (data.events) updateCalendarFromEvents(data.events);
          }
        })
        .catch(() => {
          const botMsg = document.createElement('div');
          botMsg.className = 'message bot';
          botMsg.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤.';
          chatMessages.appendChild(botMsg);
          scrollToBottom();
        });
      });

      viewAllBtn.addEventListener('click', () => {
        allEventsList.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
        eventsSidebar.classList.add('active');

        fetch('/get_all_events', { method: 'GET' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              let html = '';

              if (data.active && data.active.length > 0) {
                html += '<h3 style="color:#7bed9f; margin:16px 0 12px; border-bottom:1px solid #444; padding-bottom:6px;">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ</h3>';
                html += data.active.map(ev => {
                  const metaParts = [];
                  if (ev.city) metaParts.push(ev.city);
                  if (ev.type) metaParts.push(ev.type);
                  return `
                    <div class="event-item">
                      <div class="event-meta">${ev.date}${metaParts.length ? ' ‚Ä¢ ' + metaParts.join(' ‚Ä¢ ') : ''}</div>
                      <div class="event-title">${ev.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                    </div>
                  `;
                }).join('');
              }

              if (data.past && data.past.length > 0) {
                html += '<h3 style="color:#ff6b6b; margin:24px 0 12px; border-bottom:1px solid #444; padding-bottom:6px;">–ü—Ä–æ—à–µ–¥—à–∏–µ</h3>';
                html += data.past.map(ev => {
                  const metaParts = [];
                  if (ev.city) metaParts.push(ev.city);
                  if (ev.type) metaParts.push(ev.type);
                  return `
                    <div class="event-item">
                      <div class="event-meta" style="color:#aaa;">${ev.date}${metaParts.length ? ' ‚Ä¢ ' + metaParts.join(' ‚Ä¢ ') : ''}</div>
                      <div class="event-title" style="color:#ccc;">${ev.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                    </div>
                  `;
                }).join('');
              }

              if (!html) {
                html = '<p class="no-events">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>';
              }
              allEventsList.innerHTML = html;
            } else {
              allEventsList.innerHTML = '<p class="no-events">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.</p>';
            }
          })
          .catch(() => {
            allEventsList.innerHTML = '<p class="no-events">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.</p>';
          });
      });

      closeSidebarBtn.addEventListener('click', () => {
        eventsSidebar.classList.remove('active');
      });

      function loadManagerRequests() {
        fetch('/get_manager_requests')
          .then(r => r.json())
          .then(data => {
            const list = data.requests || [];
            if (list.length === 0) {
              managerRequestsList.innerHTML = '<p class="no-requests">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫.</p>';
            } else {
              managerRequestsList.innerHTML = list.map(req => {
                const safeText = (req.event_text || '')
                  .replace(/&/g, '&amp;')
                  .replace(/</g, '<')
                  .replace(/>/g, '>');
                return `
                  <div class="request-item" data-user-login="${req.user_login}" data-event-date="${req.event_date}">
                    <div class="request-meta">${req.user_fio} ‚Ä¢ ${req.event_date}</div>
                    <div class="request-title">${safeText}</div>
                    <div class="request-actions">
                      <button class="request-btn btn-approve" onclick="handleRequestAction('${req.user_login}', '${req.event_date}', 'approved')">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                      <button class="request-btn btn-reject" onclick="handleRequestAction('${req.user_login}', '${req.event_date}', 'rejected')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                  </div>
                `;
              }).join('');
            }
          })
          .catch(() => {
            managerRequestsList.innerHTML = '<p class="no-requests">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p>';
          });
      }

      if (viewRequestsBtn) {
        viewRequestsBtn.addEventListener('click', () => {
          managerRequestsList.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
          requestsSidebar.classList.add('active');
          loadManagerRequests();
        });
      }

      if (closeRequestsSidebarBtn) {
        closeRequestsSidebarBtn.addEventListener('click', () => {
          requestsSidebar.classList.remove('active');
        });
      }

      window.handleRequestAction = function(user_login, event_date, status) {
        fetch('/update_request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_login, event_date, status })
        })
        .then(response => {
          if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
          const item = document.querySelector(
            `.request-item[data-user-login="${user_login}"][data-event-date="${event_date}"]`
          );
          if (item) item.remove();
          if (document.querySelectorAll('.request-item').length === 0) {
            managerRequestsList.innerHTML = '<p class="no-requests">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫.</p>';
          }
        })
        .catch(() => {
          alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞—è–≤–∫–∏.');
        });
      };

      document.addEventListener('click', (e) => {
        if (eventsSidebar.classList.contains('active') &&
            !eventsSidebar.contains(e.target) &&
            !viewAllBtn.contains(e.target)) {
          eventsSidebar.classList.remove('active');
        }
        if (requestsSidebar.classList.contains('active') &&
            !requestsSidebar.contains(e.target) &&
            viewRequestsBtn && !viewRequestsBtn.contains(e.target)) {
          requestsSidebar.classList.remove('active');
        }
      });

      scrollToBottom();
    });
  </script>
</body>
</html>
